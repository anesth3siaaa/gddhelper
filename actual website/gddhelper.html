<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build a GDD - gddHELPER</title>
    <link rel="stylesheet" href="styling.css">
</head>
<body>
    <button class="toggle-navbar-btn" id="toggleNavbarBtn" onclick="toggleNavbar()">Show Navbar</button>
    
    <div class="navbar" id="navbar">
        <div class="navbar-left">
            <input type="text" class="gdd-name-editor" id="gddNameInput" placeholder="Enter GDD name...">
            
            <div class="accordion">
                <button class="accordion-button" id="fileMenuBtn">File</button>
                <div class="accordion-menu" id="fileMenu">
                    <button onclick="newGDD()">New</button>
                    <button onclick="openCustomize()">Customize</button>
                    <button id="exportBtn">Export</button>
                    <div class="submenu" id="exportSubmenu">
                        <a href="#" onclick="exportGDD('markdown')">Markdown</a>
                        <a href="#" onclick="exportGDD('html')">HTML</a>
                        <a href="#" onclick="exportGDD('richtext')">Rich Text</a>
                        <a href="#" onclick="exportGDD('basictext')">Basic Text</a>
                    </div>
                    <button onclick="openTemplates()">Templates</button>
                </div>
            </div>
        </div>

        <button class="home-button" onclick="goHome()">Return to home</button>
    </div>

    <div id="customizeModal" class="customize-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCustomize()">&times;</span>
            <h2>Customize</h2>
            <p>This feature is coming soon! More customization options will be available here.</p>
            <button class="home-button" onclick="closeCustomize()" style="margin-top: 15px;">Close</button>
        </div>
    </div>

    <div id="sectionModal" class="section-modal">
        <div class="section-modal-content">
            <span class="modal-close" onclick="closeSectionModal()">&times;</span>
            <h2>Add Section</h2>
            <div class="section-list" id="sectionList"></div>
        </div>
    </div>

    <div id="templatesModal" class="customize-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeTemplates()">&times;</span>
            <h2>Templates</h2>
            <button class="home-button" onclick="loadDefaultTemplate()" style="margin-top: 15px; width: 100%; margin-bottom: 10px;">Default Template</button>
            <button class="home-button" onclick="closeTemplates()" style="margin-top: 0; width: 100%;">Cancel</button>
        </div>
    </div>

    <div class="container">
        <h1>GDD Builder</h1>
        
        <form id="gddForm">
            <div id="sectionsContainer"></div>
        </form>
    </div>

    <script>
        const fileMenuBtn = document.getElementById('fileMenuBtn');
        const fileMenu = document.getElementById('fileMenu');
        const exportBtn = document.getElementById('exportBtn');
        const exportSubmenu = document.getElementById('exportSubmenu');
        const customizeModal = document.getElementById('customizeModal');
        const sectionModal = document.getElementById('sectionModal');
        const templatesModal = document.getElementById('templatesModal');
        const navbar = document.getElementById('navbar');
        const toggleNavbarBtn = document.getElementById('toggleNavbarBtn');
        const sectionsContainer = document.getElementById('sectionsContainer');
        const sectionList = document.getElementById('sectionList');

        const DEFAULT_SECTIONS = [
            { name: 'Game Overview', fields: ['gameName', 'gameGenre', 'targetPlatform', 'gameDescription'] },
            { name: 'Core Gameplay', fields: ['mechanics', 'playerObjective', 'difficulty'] },
            { name: 'Story & Characters', fields: ['storyOutline', 'mainCharacters'] },
            { name: 'Art & Audio', fields: ['artStyle', 'audioDescription'] },
            { name: 'Technical Requirements', fields: ['engine', 'targetSpecs'] },
            { name: 'Monetization', fields: ['monetizationModel', 'pricingStrategy'] }
        ];

        let addedSections = [];
        let customSectionCount = 0;

        fileMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileMenu.classList.toggle('show');
            exportSubmenu.classList.remove('show');
        });

        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportSubmenu.classList.toggle('show');
        });

        fileMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        document.addEventListener('click', (e) => {
            if (!fileMenuBtn.contains(e.target) && !fileMenu.contains(e.target)) {
                fileMenu.classList.remove('show');
                exportSubmenu.classList.remove('show');
            }
        });

        function newGDD() {
            if (confirm('Are you sure you want to reset your GDD? If you wish to come back to the default template, you can go to File > Templates.')) {
                document.getElementById('gddForm').reset();
                document.getElementById('gddNameInput').value = '';
                addedSections = [];
                customSectionCount = 0;
                renderSections();
                fileMenu.classList.remove('show');
            }
        }

        function openCustomize() {
            customizeModal.classList.add('show');
            fileMenu.classList.remove('show');
        }

        function closeCustomize() {
            customizeModal.classList.remove('show');
        }

        function openTemplates() {
            templatesModal.classList.add('show');
            fileMenu.classList.remove('show');
        }

        function closeTemplates() {
            templatesModal.classList.remove('show');
        }

        function loadDefaultTemplate() {
            if (confirm('Loading the default template will reset your progress. Continue?')) {
                document.getElementById('gddForm').reset();
                document.getElementById('gddNameInput').value = '';
                addedSections = DEFAULT_SECTIONS.map(section => ({ ...section, isCustom: false }));
                customSectionCount = 0;
                renderSections();
                closeTemplates();
            }
        }

        function exportGDD(format) {
            if (format === 'markdown') {
                exportMarkdown();
            } else if (format === 'html') {
                exportHTML();
            } else if (format === 'basictext') {
                exportBasicText();
            } else {
                alert(`Export as ${format.toUpperCase()} - Feature coming soon!`);
            }
            fileMenu.classList.remove('show');
            exportSubmenu.classList.remove('show');
        }

        function collectFormData() {
            const gddName = document.getElementById('gddNameInput').value || 'Untitled GDD';
            const formData = {};

            addedSections.forEach((section, index) => {
                const sectionData = { name: section.name, content: {} };

                if (section.isCustom) {
                    section.paragraphs.forEach((para, paraIndex) => {
                        const textarea = document.querySelector(`textarea[name="custom-section-${index}-para-${paraIndex}"]`);
                        if (textarea) {
                            sectionData.content[`paragraph_${paraIndex + 1}`] = textarea.value;
                        }
                    });
                } else {
                    section.fields.forEach(fieldName => {
                        const input = document.querySelector(`input[name="${fieldName}"], textarea[name="${fieldName}"]`);
                        if (input) {
                            sectionData.content[fieldName] = input.value;
                        }
                    });
                }

                formData[`section_${index}`] = sectionData;
            });

            return { gddName, formData };
        }

        function exportMarkdown() {
            const { gddName, formData } = collectFormData();
            let markdown = `# ${gddName}\n\n`;

            Object.keys(formData).forEach(key => {
                const section = formData[key];
                markdown += `## ${section.name}\n\n`;

                Object.keys(section.content).forEach(fieldKey => {
                    const value = section.content[fieldKey];
                    if (value && value.trim()) {
                        const label = fieldKey.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').trim();
                        markdown += `**${label}:** ${value}\n\n`;
                    }
                });
            });

            downloadMarkdown(markdown, gddName);
        }

        function downloadMarkdown(content, gddName) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', 'gddh-markdown.md');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function exportHTML() {
            const { gddName, formData } = collectFormData();
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(gddName)}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4979D2;
            padding-bottom: 10px;
        }
        h2 {
            color: #4979D2;
            margin-top: 30px;
        }
        h3 {
            color: #666;
            margin-top: 15px;
        }
        p {
            line-height: 1.6;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>${escapeHtml(gddName)}</h1>
`;

            Object.keys(formData).forEach(key => {
                const section = formData[key];
                html += `    <h2>${escapeHtml(section.name)}</h2>\n`;

                Object.keys(section.content).forEach(fieldKey => {
                    const value = section.content[fieldKey];
                    if (value && value.trim()) {
                        const label = fieldKey.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').trim();
                        
                        // Check if this is a custom section
                        const isCustom = fieldKey.startsWith('paragraph_');
                        
                        if (!isCustom) {
                            html += `    <h3>${escapeHtml(label)}</h3>\n`;
                        }
                        html += `    <p>${escapeHtml(value)}</p>\n`;
                    }
                });
            });

            html += `</body>
</html>`;

            downloadHTML(html, gddName);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function downloadHTML(content, gddName) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/html;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', 'gddh-html.html');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function exportBasicText() {
            const { gddName, formData } = collectFormData();
            let text = `${gddName}\n`;
            text += `${'='.repeat(gddName.length)}\n\n`;

            Object.keys(formData).forEach(key => {
                const section = formData[key];
                text += `${section.name}\n`;
                text += `${'-'.repeat(section.name.length)}\n\n`;

                Object.keys(section.content).forEach(fieldKey => {
                    const value = section.content[fieldKey];
                    if (value && value.trim()) {
                        const label = fieldKey.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').trim();
                        const isCustom = fieldKey.startsWith('paragraph_');

                        if (!isCustom) {
                            text += `${label}:\n${value}\n\n`;
                        } else {
                            text += `${value}\n\n`;
                        }
                    }
                });

                text += '\n';
            });

            downloadBasicText(text);
        }

        function downloadBasicText(content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', 'gddh-basic.txt');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function goHome() {
            window.location.href = '#placeholder';
        }

        function toggleNavbar() {
            navbar.classList.toggle('hidden');
            if (navbar.classList.contains('hidden')) {
                toggleNavbarBtn.textContent = 'Show Navbar';
                toggleNavbarBtn.classList.add('show');
            } else {
                toggleNavbarBtn.classList.remove('show');
            }
        }

        function openSectionModal() {
            populateSectionList();
            sectionModal.classList.add('show');
        }

        function closeSectionModal() {
            sectionModal.classList.remove('show');
        }

        function populateSectionList() {
            sectionList.innerHTML = '';

            DEFAULT_SECTIONS.forEach(section => {
                const isAdded = addedSections.some(s => s.name === section.name && !s.isCustom);
                const item = document.createElement('div');
                item.className = `section-item ${isAdded ? 'added' : 'available'}`;
                item.textContent = section.name;
                if (!isAdded) {
                    item.onclick = () => addSection(section);
                }
                sectionList.appendChild(item);
            });

            const customBtn = document.createElement('div');
            customBtn.className = 'section-item custom-section-btn';
            customBtn.textContent = '+ Create Custom Section';
            customBtn.onclick = createCustomSection;
            sectionList.appendChild(customBtn);
        }

        function addSection(section) {
            addedSections.push({ ...section, isCustom: false });
            renderSections();
            closeSectionModal();
        }

        function createCustomSection() {
            customSectionCount++;
            const customSection = {
                name: `Blank Section ${customSectionCount}`,
                isCustom: true,
                paragraphs: ['', '', '']
            };
            addedSections.push(customSection);
            renderSections();
            closeSectionModal();
        }

        function renderSections() {
            sectionsContainer.innerHTML = '';

            addedSections.forEach((section, index) => {
                const sectionEl = document.createElement('section');
                sectionEl.className = 'dynamic-section';
                sectionEl.draggable = true;
                sectionEl.dataset.index = index;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'section-header';

                const titleSpan = document.createElement('span');
                titleSpan.className = 'section-title editable';
                titleSpan.textContent = section.name;
                titleSpan.onclick = () => renameSection(titleSpan, index);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'section-actions';

                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'section-btn';
                moveUpBtn.textContent = '↑';
                moveUpBtn.type = 'button';
                moveUpBtn.onclick = (e) => {
                    e.preventDefault();
                    moveSection(index, -1);
                };

                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'section-btn';
                moveDownBtn.textContent = '↓';
                moveDownBtn.type = 'button';
                moveDownBtn.onclick = (e) => {
                    e.preventDefault();
                    moveSection(index, 1);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'section-btn danger';
                deleteBtn.textContent = '✕';
                deleteBtn.type = 'button';
                deleteBtn.onclick = (e) => {
                    e.preventDefault();
                    deleteSection(index);
                };

                actionsDiv.appendChild(moveUpBtn);
                actionsDiv.appendChild(moveDownBtn);
                actionsDiv.appendChild(deleteBtn);

                headerDiv.appendChild(titleSpan);
                headerDiv.appendChild(actionsDiv);
                sectionEl.appendChild(headerDiv);

                if (section.isCustom) {
                    section.paragraphs.forEach((para, paraIndex) => {
                        const paraDiv = document.createElement('div');
                        paraDiv.className = 'paragraph-input';

                        const textarea = document.createElement('textarea');
                        textarea.name = `custom-section-${index}-para-${paraIndex}`;
                        textarea.value = para;
                        paraDiv.appendChild(textarea);

                        sectionEl.appendChild(paraDiv);
                    });

                    const addParaBtn = document.createElement('button');
                    addParaBtn.className = 'add-paragraph-btn';
                    addParaBtn.textContent = '+ Add Paragraph';
                    addParaBtn.type = 'button';
                    addParaBtn.onclick = (e) => {
                        e.preventDefault();
                        addParagraph(index);
                    };
                    sectionEl.appendChild(addParaBtn);
                } else {
                    section.fields.forEach(fieldName => {
                        const label = document.createElement('label');
                        label.htmlFor = fieldName;
                        label.textContent = fieldName.replace(/([A-Z])/g, ' $1').trim() + ':';

                        let input;
                        if (['gameDescription', 'mechanics', 'playerObjective', 'difficulty', 'storyOutline', 'mainCharacters', 'audioDescription', 'targetSpecs', 'pricingStrategy'].includes(fieldName)) {
                            input = document.createElement('textarea');
                            input.rows = 4;
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                        }

                        input.id = fieldName;
                        input.name = fieldName;

                        sectionEl.appendChild(label);
                        sectionEl.appendChild(input);
                    });
                }

                sectionEl.addEventListener('dragstart', handleDragStart);
                sectionEl.addEventListener('dragover', handleDragOver);
                sectionEl.addEventListener('drop', handleDrop);
                sectionEl.addEventListener('dragend', handleDragEnd);

                sectionsContainer.appendChild(sectionEl);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'add-section-btn';
            addBtn.type = 'button';
            addBtn.textContent = '+';
            addBtn.onclick = openSectionModal;
            sectionsContainer.appendChild(addBtn);
        }

        function renameSection(element, index) {
            const currentName = element.textContent;
            const newName = prompt('Enter new section name:', currentName);
            if (newName && newName.trim()) {
                addedSections[index].name = newName.trim();
                element.textContent = newName.trim();
            }
        }

        function moveSection(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < addedSections.length) {
                [addedSections[index], addedSections[newIndex]] = [addedSections[newIndex], addedSections[index]];
                renderSections();
            }
        }

        function deleteSection(index) {
            if (confirm('Are you sure you want to delete this section?')) {
                addedSections.splice(index, 1);
                renderSections();
            }
        }

        function addParagraph(index) {
            addedSections[index].paragraphs.push('');
            renderSections();
        }

        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = this.dataset.index;
            this.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetIndex = this.dataset.index;
            if (draggedIndex !== null && draggedIndex !== targetIndex) {
                [addedSections[draggedIndex], addedSections[targetIndex]] = [addedSections[targetIndex], addedSections[draggedIndex]];
                renderSections();
            }
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            draggedIndex = null;
        }

        // Initialize with default template
        addedSections = DEFAULT_SECTIONS.map(section => ({ ...section, isCustom: false }));
        renderSections();
    </script>
</body>
</html>